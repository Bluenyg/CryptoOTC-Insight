<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAS-Quant Pro | Êô∫ËÉΩÈáèÂåñÁªàÁ´Ø</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root { --bg-dark: #0b0e14; --panel-bg: #151923; --border-color: #2a2f3e; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* Ëá™ÂÆö‰πâÊªöÂä®Êù° */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .anim-pulse { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .chart-container { position: relative; height: 200px; width: 100%; }

        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }

        /* ÁÆÄÂçïÁöÑÊ∑°ÂÖ•Âä®Áîª */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app" class="h-screen flex flex-col" v-cloak>

        <header class="h-14 border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-50 flex items-center justify-between px-6 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center text-white font-bold font-mono">M</div>
                <span class="font-bold text-lg tracking-tight text-slate-200">MAS-Quant <span class="text-indigo-400 text-xs uppercase px-1.5 py-0.5 bg-indigo-500/10 rounded border border-indigo-500/20">Pro</span></span>
            </div>
            <div class="flex items-center gap-4 text-xs font-mono text-slate-400">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 anim-pulse"></span>
                    <span>SYSTEM ONLINE</span>
                </div>
                <span>UPDATED: {{ lastUpdated }}</span>
                <a href="/logout" class="ml-2 text-slate-500 hover:text-red-400 transition-colors" title="Logout">
                    <i class="ri-logout-box-r-line text-lg"></i>
                </a>
            </div>
        </header>

        <main class="flex-1 w-full max-w-[1920px] mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-3.5rem)] overflow-hidden">

            <div class="lg:col-span-3 flex flex-col gap-6 overflow-y-auto h-full pr-1 pb-10">

                <div class="glass-panel p-5 relative overflow-hidden group min-h-[180px] shrink-0">
                    <div class="absolute -right-6 -top-6 opacity-5 group-hover:opacity-10 transition">
                        <i class="ri-radar-line text-9xl text-white"></i>
                    </div>
                    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-3">Macro Signal (24H)</h3>

                    <div v-if="latestSignal" class="relative z-10">
                        <div class="flex items-end gap-2 mb-2">
                            <span class="text-3xl font-black tracking-tighter" :class="getSignalColor(latestSignal.direction)">
                                {{ latestSignal.direction }}
                            </span>
                        </div>
                        <div class="flex items-center gap-2 mb-4 text-xs font-mono text-slate-400">
                            <span>CONFIDENCE:</span>
                            <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-500"
                                     :class="getSignalColorBg(latestSignal.direction)"
                                     :style="{ width: (latestSignal.confidence * 100) + '%' }"></div>
                            </div>
                            <span>{{ (latestSignal.confidence * 100).toFixed(0) }}%</span>
                        </div>
                        <p class="text-xs text-slate-300 leading-relaxed border-t border-slate-700/50 pt-3">
                            {{ latestSignal.reasoning }}
                        </p>

                        <div class="mt-3">
                            <button @click="showTrendDetails = !showTrendDetails"
                                    class="text-[10px] flex items-center gap-1 text-indigo-400 hover:text-indigo-300 transition-colors font-mono cursor-pointer outline-none select-none">
                                <i :class="showTrendDetails ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"></i>
                                {{ showTrendDetails ? 'Hide Chain of Thought' : 'View Chain of Thought' }}
                            </button>

                            <div v-if="showTrendDetails" class="mt-2 p-3 bg-slate-950/50 rounded border border-slate-800 text-[10px] text-slate-400 font-mono leading-relaxed whitespace-pre-wrap" style="animation: fadeIn 0.2s ease-out;">
                                {{ latestSignal.chain_of_thought || 'No detailed chain of thought available.' }}
                            </div>
                        </div>
                        <div class="text-[10px] text-slate-500 font-mono text-right flex items-center justify-end gap-1 mt-2">
                            <i class="ri-time-line"></i> Predict Time: {{ formatTime(latestSignal.timestamp) }}
                        </div>
                    </div>
                    <div v-else class="h-24 flex items-center justify-center text-slate-600 text-xs">
                        <span class="animate-pulse">Waiting for Trend Agent...</span>
                    </div>
                </div>

                <div @click="openHistoryModal"
                     class="glass-panel p-5 relative overflow-hidden group min-h-[180px] shrink-0 cursor-pointer hover:border-indigo-500/50 transition-colors">

                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-[10px] text-indigo-400 font-mono bg-indigo-500/10 px-2 py-1 rounded">
                        <i class="ri-bar-chart-line mr-1"></i>View Analysis
                    </div>

                    <div class="absolute -right-6 -top-6 opacity-5 group-hover:opacity-10 transition">
                        <i class="ri-flashlight-fill text-9xl text-yellow-500"></i>
                    </div>
                    <div class="flex items-center gap-2 mb-3">
                        <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider">Short-Term Signal (1H)</h3>
                        <span class="flex h-2 w-2 relative">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
                        </span>
                    </div>

                    <div v-if="latestShortTerm" class="relative z-10">
                        <div class="flex items-end gap-2 mb-2">
                             <span class="text-3xl font-black tracking-tighter" :class="getSignalColor(latestShortTerm.direction)">
                                {{ latestShortTerm.direction }}
                            </span>
                        </div>

                        <div class="flex items-center gap-2 mb-3 text-xs font-mono text-slate-400">
                            <span>CONFIDENCE:</span>
                            <div class="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full transition-all duration-500"
                                     :class="getSignalColorBg(latestShortTerm.direction)"
                                     :style="{ width: (latestShortTerm.confidence * 100) + '%' }"></div>
                            </div>
                            <span>{{ (latestShortTerm.confidence * 100).toFixed(0) }}%</span>
                        </div>

                        <p class="text-xs text-slate-300 leading-relaxed border-t border-slate-700/50 pt-2 mb-2">
                            {{ latestShortTerm.reasoning }}
                        </p>

                        <div class="mt-2 mb-2">
                            <button @click.stop="showShortTermDetails = !showShortTermDetails"
                                    class="text-[10px] flex items-center gap-1 text-yellow-500/80 hover:text-yellow-400 transition-colors font-mono cursor-pointer outline-none select-none">
                                <i :class="showShortTermDetails ? 'ri-arrow-up-s-line' : 'ri-arrow-down-s-line'"></i>
                                {{ showShortTermDetails ? 'Hide Logic' : 'View Logic' }}
                            </button>

                            <div v-if="showShortTermDetails" class="mt-2 p-3 bg-slate-950/50 rounded border border-slate-800 text-[10px] text-slate-400 font-mono leading-relaxed whitespace-pre-wrap" style="animation: fadeIn 0.2s ease-out;">
                                {{ latestShortTerm.chain_of_thought || 'No detailed logic available.' }}
                            </div>
                        </div>

                        <div class="text-[10px] text-slate-500 font-mono text-right flex items-center justify-end gap-1 mt-2">
                            <i class="ri-time-line"></i> Predict Time: {{ formatTime(latestShortTerm.timestamp) }}
                        </div>
                    </div>
                    <div v-else class="h-20 flex items-center justify-center text-slate-600 text-xs">
                         <span class="animate-pulse">Waiting for 1H Agent...</span>
                    </div>
                </div>

                <div class="glass-panel p-5 flex flex-col shrink-0">
                    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Sentiment Distribution</h3>
                    <div class="chart-container flex items-center justify-center">
                        <canvas id="sentimentChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div class="text-center mt-2">
                                <span class="block text-3xl font-bold text-white tracking-tighter">{{ stats.tagged_count }}</span>
                                <span class="text-[10px] text-slate-500 uppercase tracking-widest">Valid Items</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between mt-4 text-[10px] text-slate-400 font-mono px-2">
                        <div class="text-center">
                            <span class="block text-emerald-400 font-bold text-lg">{{ stats.bullish }}</span>
                            <span>BULL</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-slate-300 font-bold text-lg">{{ stats.neutral }}</span>
                            <span>NEUT</span>
                        </div>
                        <div class="text-center">
                            <span class="block text-rose-400 font-bold text-lg">{{ stats.bearish }}</span>
                            <span>BEAR</span>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-5 shrink-0">
                    <h3 class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-4">Pipeline Status</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-400">Total Filtered (Noise)</span>
                            <span class="font-mono text-sm text-slate-500">{{ stats.noise_count }}</span>
                        </div>
                        <div class="h-px bg-slate-700/50 my-2"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-300">Raw BTC Source</span>
                            <span class="font-mono text-sm text-slate-200">{{ stats.btc_count }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-300">Raw ETH Source</span>
                            <span class="font-mono text-sm text-slate-200">{{ stats.eth_count }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-9 glass-panel flex flex-col overflow-hidden h-full">
                <div class="p-4 border-b border-slate-800 flex flex-wrap items-center justify-between gap-4 bg-slate-900/30 shrink-0">
                    <div class="flex items-center gap-4">
                        <h2 class="text-sm font-bold text-slate-200 flex items-center gap-2">
                            <i class="ri-file-list-3-line text-indigo-500"></i> INTELLIGENCE FEED
                        </h2>
                        <div class="flex bg-slate-800 p-0.5 rounded text-xs font-medium">
                            <button @click="activeTab = 'relevant'"
                                    class="px-3 py-1 rounded transition"
                                    :class="activeTab === 'relevant' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'">
                                Relevant
                            </button>
                            <button @click="activeTab = 'noise'"
                                    class="px-3 py-1 rounded transition"
                                    :class="activeTab === 'noise' ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'">
                                Noise Log
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <select v-model="filter.coin" class="bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded px-2 py-1.5 focus:border-indigo-500 outline-none">
                            <option value="ALL">All Assets</option>
                            <option value="BTC">BTC</option>
                            <option value="ETH">ETH</option>
                        </select>
                        <select v-model="filter.sentiment" class="bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded px-2 py-1.5 focus:border-indigo-500 outline-none">
                            <option value="ALL">All Sentiments</option>
                            <option value="1">Bullish</option>
                            <option value="3">Bearish</option>
                            <option value="2">Neutral</option>
                        </select>
                    </div>
                </div>

                <div class="flex-1 overflow-auto relative">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900/90 sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                            <tr class="text-[10px] font-bold font-mono text-slate-500 border-b border-slate-800 uppercase tracking-wider">
                                <th class="p-3 w-32 pl-5">Time (UTC+8)</th>
                                <th class="p-3 w-20">Asset</th>
                                <th class="p-3 w-28">Sentiment</th>
                                <th class="p-3">Summary & Analysis</th>
                                <th class="p-3 w-24 text-right pr-5">Quant Score</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800/50 text-sm">
                            <tr v-if="filteredList.length === 0">
                                <td colspan="5" class="p-20 text-center text-slate-500 flex flex-col items-center justify-center">
                                    <i class="ri-inbox-line text-4xl mb-2 opacity-20"></i>
                                    <p>No data available for current filter</p>
                                </td>
                            </tr>
                            <tr v-for="item in filteredList" :key="item.objectId" class="hover:bg-slate-800/30 group transition-colors">
                                <td class="p-3 pl-5 font-mono text-xs text-slate-400 align-top pt-4 whitespace-nowrap">
                                    {{ formatTime(item.time) }}
                                </td>
                                <td class="p-3 align-top pt-4">
                                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border"
                                          :class="item.coin_type === 'BTC' ? 'bg-orange-500/10 border-orange-500/20 text-orange-400' : 'bg-purple-500/10 border-purple-500/20 text-purple-400'">
                                        {{ item.coin_type }}
                                    </span>
                                </td>
                                <td class="p-3 align-top pt-4">
                                    <div v-if="item.newsTag === 4">
                                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-500 border border-slate-700 inline-flex items-center gap-1">
                                            <i class="ri-filter-line"></i> NOISE
                                        </span>
                                    </div>
                                    <div v-else-if="item.newsTag === 0">
                                        <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-900/20 text-blue-400 border border-blue-800/50 animate-pulse inline-flex items-center gap-1">
                                            <i class="ri-loader-4-line animate-spin"></i> PENDING
                                        </span>
                                    </div>
                                    <div v-else>
                                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full border flex w-fit items-center gap-1.5 shadow-sm"
                                              :class="getTagStyle(item.newsTag)">
                                            <span class="w-1.5 h-1.5 rounded-full" :class="getTagDot(item.newsTag)"></span>
                                            {{ getTagName(item.newsTag) }}
                                        </span>
                                    </div>
                                </td>
                                <td class="p-3 align-top pt-4 max-w-xl">
                                    <div class="text-slate-200 font-medium leading-snug mb-1.5 text-sm line-clamp-2">
                                        {{ item.summary || item.title }}
                                    </div>
                                    <div class="flex flex-wrap gap-2 items-center text-xs text-slate-500">
                                        <div v-if="item.latest_short_term"
                                             class="bg-slate-800/50 px-1.5 py-0.5 rounded border border-slate-700/50 text-[10px] font-mono flex items-center gap-1">
                                            <span>1H:</span>
                                            <span :class="getSignalColor(item.latest_short_term.direction)">{{ item.latest_short_term.direction }}</span>
                                        </div>

                                        <div v-if="extractImpact(item.analysis)"
                                             class="bg-slate-800/50 px-1.5 py-0.5 rounded border border-slate-700/50 text-[10px] text-slate-400 font-mono">
                                            IMPACT: {{ extractImpact(item.analysis) }}
                                        </div>
                                        <span class="opacity-30" v-if="extractImpact(item.analysis)">|</span>
                                        <a :href="item.link" target="_blank" class="hover:text-indigo-400 transition flex items-center gap-1">
                                            Source <i class="ri-external-link-line"></i>
                                        </a>
                                    </div>
                                </td>
                                <td class="p-3 pr-5 align-top pt-4 text-right">
                                    <span class="font-mono font-bold text-sm"
                                          :class="getScoreColor(extractScore(item.analysis))">
                                        {{ extractScore(item.analysis) }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <div v-if="showHistoryModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" @click.self="closeHistoryModal">
            <div class="bg-[#151923] border border-slate-700 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl relative animate-[fadeIn_0.2s_ease-out]">

                <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 rounded-t-xl">
                    <div>
                        <h2 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="ri-history-line text-indigo-500"></i> 1H Prediction Accuracy (Full History)
                        </h2>
                        <p class="text-xs text-slate-400 mt-1">Comparing ALL historical 1H predictions vs Actual Market Moves</p>
                    </div>
                    <button @click="closeHistoryModal" class="text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 p-2 rounded-full transition">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-hidden flex flex-col p-6 gap-6">

                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-slate-900/50 border border-slate-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Total Signals</div>
                            <div class="text-2xl font-mono font-bold text-white">{{ predictionHistory.length }}</div>
                        </div>
                        <div class="bg-slate-900/50 border border-slate-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Accuracy</div>
                            <div class="text-2xl font-mono font-bold" :class="accuracyRate >= 50 ? 'text-emerald-400' : 'text-rose-400'">
                                {{ accuracyRate.toFixed(0) }}%
                            </div>
                        </div>
                        <div class="bg-slate-900/50 border border-slate-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Correct</div>
                            <div class="text-2xl font-mono font-bold text-emerald-400">{{ correctCount }}</div>
                        </div>
                        <div class="bg-slate-900/50 border border-slate-800 p-4 rounded-lg text-center">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Asset</div>
                            <div class="text-2xl font-mono font-bold text-orange-400">BTC</div>
                        </div>
                    </div>

                    <div class="flex-1 bg-slate-900/30 border border-slate-800 rounded-lg p-4 relative min-h-0">
                        <canvas id="historyChart"></canvas>
                        <div v-if="isLoadingHistory" class="absolute inset-0 flex items-center justify-center bg-slate-900/80 z-10">
                            <div class="flex flex-col items-center">
                                <i class="ri-loader-4-line text-3xl animate-spin text-indigo-500 mb-2"></i>
                                <span class="text-xs text-slate-400">Loading Market Data...</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue

        createApp({
            setup() {
                const allData = ref([])
                const lastUpdated = ref('-')
                const latestSignal = ref(null)
                const latestShortTerm = ref(null)

                // „ÄêÊñ∞Â¢û„ÄëÊéßÂà∂ËØ¶ÁªÜÊé®Êºî(Chain of Thought)ÊòæÁ§∫ÁöÑÂºÄÂÖ≥
                const showTrendDetails = ref(false)
                const showShortTermDetails = ref(false)

                const chartInstance = ref(null)
                const historyChartInstance = ref(null)
                const activeTab = ref('relevant')
                const filter = ref({ coin: 'ALL', sentiment: 'ALL' })
                const stats = ref({ btc_count: 0, eth_count: 0, tagged_count: 0, noise_count: 0, bullish: 0, neutral: 0, bearish: 0 })

                const showHistoryModal = ref(false)
                const isLoadingHistory = ref(false)
                const predictionHistory = ref([])
                const correctCount = ref(0)
                const accuracyRate = ref(0)

                // --- Helper Functions ---
                const formatTime = (t) => {
                    if (!t) return '-'
                    // „Äê‰øÆÂ§ç„ÄëÂ¶ÇÊûúÂåÖÂê´ T ‰ΩÜ‰∏çÂê´ ZÔºåÂº∫Âà∂Ë°•‰∏ä Z ‰ª•Á°Æ‰øùË¢´Ëß£Êûê‰∏∫ UTC
                    let timeStr = t;
                    if (typeof timeStr === 'string' && timeStr.includes('T') && !timeStr.endsWith('Z')) {
                        timeStr += 'Z';
                    }

                    const date = new Date(timeStr);
                    return date.toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }

                const getTagName = (tag) => {
                    const t = parseInt(tag)
                    const map = { 1: 'BULLISH', 2: 'NEUTRAL', 3: 'BEARISH', 4: 'NOISE', 0: 'PENDING' }
                    return map[t] || 'UNKNOWN'
                }

                const getTagStyle = (tag) => ({
                    1: 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400',
                    2: 'bg-slate-500/10 border-slate-500/20 text-slate-400',
                    3: 'bg-rose-500/10 border-rose-500/20 text-rose-400'
                }[tag])

                const getTagDot = (tag) => ({ 1: 'bg-emerald-500', 2: 'bg-slate-500', 3: 'bg-rose-500' }[tag])

                const getSignalColor = (trend) => {
                    if (!trend) return 'text-slate-400';
                    const t = trend.toUpperCase();
                    if (t === 'BULLISH') return 'text-emerald-400'
                    if (t === 'BEARISH') return 'text-rose-400'
                    return 'text-slate-400'
                }
                const getSignalColorBg = (trend) => {
                    if (!trend) return 'bg-slate-400';
                    const t = trend.toUpperCase();
                    if (t === 'BULLISH') return 'bg-emerald-500'
                    if (t === 'BEARISH') return 'bg-rose-500'
                    return 'bg-slate-400'
                }

                const extractScore = (analysis) => {
                    if (!analysis) return '-'
                    const match = analysis.match(/(?:Score|score)\s*[:=\s]\s*([-\d\.]+)/)
                    return match ? parseFloat(match[1]).toFixed(2) : '-'
                }

                const extractImpact = (analysis) => {
                    if (!analysis) return ''
                    const match = analysis.match(/(?:Impact|impact)\s*[:=\s]\s*([A-Z]+)/i)
                    return match ? match[1].toUpperCase() : ''
                }

                const getScoreColor = (score) => {
                    if (score === '-') return 'text-slate-600'
                    const val = parseFloat(score)
                    if (val > 0.3) return 'text-emerald-400'
                    if (val < -0.3) return 'text-rose-400'
                    return 'text-slate-400'
                }

                // --- Core Logic ---
                const fetchData = async () => {
                    try {
                        const res = await fetch(`/api/dashboard/data?t=${Date.now()}`)
                        if (res.redirected) { window.location.href = res.url; return; }
                        const json = await res.json()
                        let freshData = json.data || []
                        freshData = freshData.map(item => {
                            let raw = item.newsTag !== undefined ? item.newsTag : item.newTag
                            item.newsTag = parseInt(raw) || 0
                            return item
                        })
                        freshData.sort((a, b) => {
                            const tA = a.time || ''
                            const tB = b.time || ''
                            return tB.localeCompare(tA)
                        })
                        allData.value = freshData
                        lastUpdated.value = json.updated_at

                        processStats(freshData)
                        extractSignals(freshData)

                        updateChart()
                    } catch (e) { console.error("Fetch error", e) }
                }

                const processStats = (data) => {
                    let s = { btc_count: 0, eth_count: 0, tagged_count: 0, noise_count: 0, bullish: 0, neutral: 0, bearish: 0 }
                    data.forEach(i => {
                        if (i.coin_type === 'BTC') s.btc_count++
                        if (i.coin_type === 'ETH') s.eth_count++
                        const tag = parseInt(i.newsTag)
                        if (tag === 4) { s.noise_count++ }
                        else if ([1, 2, 3].includes(tag)) {
                            s.tagged_count++
                            if (tag === 1) s.bullish++
                            if (tag === 2) s.neutral++
                            if (tag === 3) s.bearish++
                        }
                    })
                    stats.value = s
                }

                const extractSignals = (data) => {
    latestSignal.value = null;
    latestShortTerm.value = null;

    // --- ‰øÆÂ§çÂêéÁöÑ 24H ‰ø°Âè∑ÊèêÂèñÈÄªËæë ---
    let maxTrendTs = 0;

    for (const item of data) {
        if (item.latest_trend && item.latest_trend.timestamp) {
            // 1. Ëé∑Âèñ‰ø°Âè∑ÁöÑÊó∂Èó¥Êà≥ (Â§ÑÁêÜ UTC Ê†ºÂºè)
            let tsStr = item.latest_trend.timestamp;
            if (typeof tsStr === 'string' && tsStr.includes('T') && !tsStr.endsWith('Z')) {
                tsStr += 'Z';
            }
            const ts = new Date(tsStr).getTime();

            // 2. ÊØîÂØπÔºö‰øùÁïô‚ÄúÊúÄÊñ∞ÁîüÊàê‚ÄùÁöÑÈÇ£‰∏™‰ø°Âè∑ÔºåËÄå‰∏çÊòØ‚ÄúÊúÄÊñ∞Êñ∞Èóª‚ÄùÁöÑ‰ø°Âè∑
            if (ts > maxTrendTs) {
                maxTrendTs = ts;
                latestSignal.value = item.latest_trend;
            }
        }
    }

    // --- ‰øÆÂ§çÂêéÁöÑ 1H ‰ø°Âè∑ÊèêÂèñÈÄªËæë (ÂêåÁêÜ) ---
    let maxShortTs = 0;

    for (const item of data) {
        if (item.latest_short_term && item.latest_short_term.timestamp) {
            let tsStr = item.latest_short_term.timestamp;
            if (typeof tsStr === 'string' && tsStr.includes('T') && !tsStr.endsWith('Z')) {
                tsStr += 'Z';
            }
            const ts = new Date(tsStr).getTime();

            if (ts > maxShortTs) {
                maxShortTs = ts;
                latestShortTerm.value = item.latest_short_term;
            }
        }
    }
}

                // --- History Modal Logic ---
                const openHistoryModal = async () => {
                    showHistoryModal.value = true
                    isLoadingHistory.value = true
                    await nextTick()

                    const predictions = []

                    allData.value.forEach(item => {
                        const structured = item.structured_analysis || {};
                        const signalsList = structured.short_term_signals || [];

                        // 1. Êñ∞ JSON Ê†ºÂºèÈÅçÂéÜ
                        if (Array.isArray(signalsList)) {
                            signalsList.forEach(sig => {
                                if (sig.timestamp && sig.direction) {
                                    let tsStr = sig.timestamp;
                                    if (!tsStr.endsWith('Z')) tsStr += 'Z';

                                    const ts = new Date(tsStr).getTime();

                                    predictions.push({
                                        time: ts,
                                        trend: sig.direction.toUpperCase(),
                                        rawTime: sig.timestamp
                                    });
                                }
                            });
                        }

                        // 2. Êóß String Ê†ºÂºèÂÖºÂÆπ
                        if (predictions.length === 0 && item.analysis && item.analysis.includes('„Äê1H_PREDICTION„Äë')) {
                             try {
                                const raw = item.analysis.split('„Äê1H_PREDICTION„Äë:')[1]
                                const parts = raw.split('||')[0].split('|')
                                const bjTimeString = item.time.replace(' ', 'T') + '+08:00';
                                const ts = new Date(bjTimeString).getTime();
                                predictions.push({ time: ts, trend: parts[1].trim().toUpperCase() });
                             } catch(e) {}
                        }
                    })

                    predictions.sort((a, b) => a.time - b.time)
                    predictionHistory.value = predictions

                    try {
                        const res = await fetch('/api/market/history?symbol=BTCUSDT&interval=1h&limit=72')
                        const json = await res.json()
                        if (json.data) {
                            renderHistoryChart(json.data, predictions)
                        }
                    } catch(e) { console.error("History fetch error", e) }

                    isLoadingHistory.value = false
                }

                const closeHistoryModal = () => {
                    showHistoryModal.value = false
                    if (historyChartInstance.value) {
                        historyChartInstance.value.destroy()
                        historyChartInstance.value = null
                    }
                }

                // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÊ∏≤ÊüìÂéÜÂè≤ÂõæË°®ÈÄªËæë ---
                const renderHistoryChart = (klines, predictions) => {
                    const ctx = document.getElementById('historyChart')
                    if (!ctx) return

                    // Êï∞ÊçÆÊ∫êÔºöÂ∏ÅÂÆâKÁ∫ø [time, open, high, low, close]
                    // Êàë‰ª¨‰ΩøÁî® 'close' Êù•ÁîªÁ∫øÔºå‰ΩøÁî® 'time' ‰Ωú‰∏∫XËΩ¥
                    const priceData = klines.map(k => ({ x: k.time, y: k.close }))

                    let correct = 0
                    let totalValid = 0
                    const predictionPoints = []

                    predictions.forEach(pred => {
                        const newsTime = pred.time // È¢ÑÊµã‰∫ßÁîüÁöÑ UTC Êó∂Èó¥
                        const targetTime = newsTime + 3600 * 1000 // 1Â∞èÊó∂Âêé

                        // Êü•ÊâæÂØπÂ∫îÁöÑ K Á∫ø
                        // startK: ‰ø°Âè∑ÂèëÁîüÊó∂ÊâÄÂú®ÁöÑKÁ∫ø
                        const startK = klines.find(k => k.time <= newsTime && newsTime < k.time + 3600000)
                        // endK: 1Â∞èÊó∂ÂêéÁî®‰∫éÈ™åËØÅÁªìÊûúÁöÑKÁ∫ø
                        const endK = klines.find(k => k.time <= targetTime && targetTime < k.time + 3600000)

                        if (startK && endK && pred.trend !== 'NEUTRAL') {
                            const startPrice = startK.close
                            const endPrice = endK.close
                            const priceChange = endPrice - startPrice

                            // Âà§Êñ≠È¢ÑÊµãÂáÜÁ°ÆÊÄß
                            let isCorrect = false
                            if (pred.trend === 'BULLISH' && priceChange > 0) isCorrect = true
                            if (pred.trend === 'BEARISH' && priceChange < 0) isCorrect = true

                            if (isCorrect) correct++
                            totalValid++

                            // „Äê‰øÆÂ§çÂÖ≥ÈîÆÁÇπ„ÄëÔºö
                            // ‰∏∫‰∫ÜËÆ©ÁÇπÂÆåÁæéËêΩÂú®Êõ≤Á∫ø‰∏äÔºåÊàë‰ª¨Â∞ÜÁÇπÁöÑÂùêÊ†á (x, y) Âº∫Âà∂ÂØπÈΩêÂà∞ KÁ∫øÁöÑ time Âíå close
                            // ËøôÊ†∑ÁÇπÂ∞±‰ºö‚ÄúÂê∏ÈôÑ‚ÄùÂú®ÊäòÁ∫øÁöÑÊãêÁÇπ‰∏äÔºåËÄå‰∏çÊòØÊÇ¨ÊµÆÂú®ÊóÅËæπ
                            predictionPoints.push({
                                x: startK.time,      // ‰ΩøÁî®KÁ∫øÊó∂Èó¥ÔºåËÄå‰∏çÊòØÊñ∞ÈóªÊó∂Èó¥
                                y: startK.close,     // ‰ΩøÁî®KÁ∫øÊî∂Áõò‰ª∑ÔºåÁ°Æ‰øùÂú®Á∫ø‰∏ä
                                trend: pred.trend,
                                isCorrect: isCorrect,
                                actualChange: priceChange,
                                originalTime: pred.time // ‰øùÁïôÂéüÂßãÊó∂Èó¥Áî®‰∫éTooltipÂ±ïÁ§∫
                            })
                        }
                    })

                    correctCount.value = correct
                    accuracyRate.value = totalValid > 0 ? (correct / totalValid * 100) : 0

                    if (historyChartInstance.value) historyChartInstance.value.destroy()

                    historyChartInstance.value = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [
                                {
                                    label: 'BTC Price (1H)',
                                    data: priceData,
                                    borderColor: '#6366f1',
                                    borderWidth: 2,
                                    tension: 0.1, // Á®çÂæÆÂπ≥Êªë‰∏ÄÁÇπ
                                    pointRadius: 0,
                                    pointHoverRadius: 0
                                },
                                {
                                    label: 'Signals',
                                    type: 'scatter',
                                    data: predictionPoints,
                                    pointStyle: 'circle',
                                    pointRadius: 6,        // ÁÇπÁ®çÂæÆÂ§ß‰∏ÄÁÇπ
                                    pointHoverRadius: 10,
                                    // „ÄêÈ¢úËâ≤ÈÄªËæë‰øÆÂ§ç„ÄëÔºö
                                    // ËÉåÊôØËâ≤ = È¢ÑÊµãÊñπÂêë (Áªø=Ê∂®ÔºåÁ∫¢=Ë∑å)
                                    pointBackgroundColor: (ctx) => {
                                        const raw = ctx.raw
                                        if (!raw) return '#888'
                                        return raw.trend === 'BULLISH' ? '#10b981' : '#f43f5e'
                                    },
                                    // ËæπÊ°ÜËâ≤ = È¢ÑÊµãÂáÜÁ°ÆÊÄß
                                    // Â¶ÇÊûúÈ¢ÑÊµãÊ≠£Á°ÆÔºåËæπÊ°Ü‰∏∫ÁôΩËâ≤ÔºõÂ¶ÇÊûúÈîôËØØÔºåËæπÊ°ÜÈÄèÊòéÔºàÊàñÂèç‰πãÔºåËøôÈáåÁî®ÁôΩËâ≤Á™ÅÊòæÊ≠£Á°ÆÁÇπÔºåÊàñËÄÖËÆ©ÈîôËØØÁöÑÁÇπÊòæÁúºÔºâ
                                    // ÁÆÄÂåñÔºöËøôÈáåÁªü‰∏ÄÁî®ÁôΩËâ≤ËæπÊ°ÜÔºå‰ΩÜÂ¶ÇÊûúÊòØÈîôËØØÁöÑÔºåÂèØ‰ª•Âä†Á≤óËæπÊ°ÜÊàñÊîπÂèòËæπÊ°ÜÈ¢úËâ≤
                                    pointBorderColor: (ctx) => {
                                        const raw = ctx.raw
                                        if (!raw) return '#fff'
                                        return raw.isCorrect ? '#ffffff' : '#000000' // ÈîôËØØÁÇπÁî®ÈªëËæπÊ°ÜÂå∫ÂàÜ
                                    },
                                    pointBorderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const raw = context[0].raw;
                                            // Tooltip ÊòæÁ§∫ÁúüÂÆûÁöÑ‰ø°Âè∑Êó∂Èó¥ÔºåËÄå‰∏çÊòØÂØπÈΩêÂêéÁöÑKÁ∫øÊó∂Èó¥
                                            const ts = raw.originalTime || context[0].parsed.x;
                                            return new Date(ts).toLocaleString('zh-CN', {
                                                timeZone: 'Asia/Shanghai',
                                                month: '2-digit', day: '2-digit',
                                                hour: '2-digit', minute: '2-digit', hour12: false
                                            });
                                        },
                                        label: function(context) {
                                            const raw = context.raw
                                            if (raw.trend) {
                                                const status = raw.isCorrect ? '‚úÖ Hit' : '‚ùå Miss'
                                                const trendIcon = raw.trend === 'BULLISH' ? 'üìà Bull' : 'üìâ Bear'
                                                return `${trendIcon} | Result: ${status} ($${raw.actualChange.toFixed(2)})`
                                            } else {
                                                return `Price: $${raw.y}`
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'hour',
                                        tooltipFormat: 'yyyy-MM-dd HH:mm',
                                    },
                                    ticks: {
                                        color: '#64748b',
                                        maxRotation: 45,
                                        minRotation: 45,
                                        callback: function(val) {
                                            return new Date(val).toLocaleTimeString('zh-CN', {
                                                timeZone: 'Asia/Shanghai',
                                                hour: '2-digit', minute: '2-digit', hour12: false
                                            });
                                        }
                                    },
                                    grid: { color: '#1e293b' }
                                },
                                y: {
                                    grid: { color: '#1e293b' },
                                    ticks: { color: '#64748b' }
                                }
                            }
                        }
                    })
                }

                const filteredList = computed(() => {
                    return allData.value.filter(item => {
                        const tag = parseInt(item.newsTag)
                        if (activeTab.value === 'relevant') {
                            if (tag === 4) return false
                        } else {
                            if (tag !== 4) return false
                        }
                        if (activeTab.value === 'relevant') {
                             if (filter.value.coin !== 'ALL' && item.coin_type !== filter.value.coin) return false
                             if (filter.value.sentiment !== 'ALL') {
                                 if (tag != parseInt(filter.value.sentiment)) return false
                             }
                        }
                        return true
                    }).slice(0, 100)
                })

                const updateChart = () => {
                    const ctx = document.getElementById('sentimentChart')
                    if (!ctx) return
                    const data = [stats.value.bullish, stats.value.neutral, stats.value.bearish]
                    const total = data.reduce((a, b) => a + b, 0)
                    const displayData = total === 0 ? [1] : data
                    const displayColors = total === 0 ? ['#1e293b'] : ['#34d399', '#64748b', '#fb7185']

                    if (chartInstance.value) {
                        chartInstance.value.data.datasets[0].data = displayData
                        chartInstance.value.data.datasets[0].backgroundColor = displayColors
                        chartInstance.value.update()
                    } else {
                        chartInstance.value = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Bull', 'Neut', 'Bear'],
                                datasets: [{
                                    data: displayData,
                                    backgroundColor: displayColors,
                                    borderWidth: 0,
                                    hoverOffset: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '85%',
                                plugins: { legend: { display: false }, tooltip: { enabled: total > 0 } }
                            }
                        })
                    }
                }

                onMounted(() => {
                    fetchData()
                    setInterval(fetchData, 15000)
                })

                return {
                    allData, filteredList, lastUpdated, latestSignal, latestShortTerm, stats, filter, activeTab,
                    showHistoryModal, isLoadingHistory, predictionHistory, correctCount, accuracyRate,
                    openHistoryModal, closeHistoryModal,
                    formatTime, getTagName, getTagStyle, getTagDot, getSignalColor, getSignalColorBg,
                    extractScore, extractImpact, getScoreColor,
                    showTrendDetails, showShortTermDetails
                }
            }
        }).mount('#app')
    </script>
</body>
</html>